<!DOCTYPE html> 
<html lang="en">
	<head>
		<meta charset="utf-8">
		<title>FastDoc</title>
		<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=0">
		
		<!-- Favicons -->
		<link href="assets\img\favicon2.png" rel="icon">
		
		<!-- Bootstrap CSS -->
		<link rel="stylesheet" href="assets\css\bootstrap.min.css">
		
		<!-- Fontawesome CSS -->
		<link rel="stylesheet" href="assets\plugins\fontawesome\css\fontawesome.min.css">
		<link rel="stylesheet" href="assets\plugins\fontawesome\css\all.min.css">
		
		<!-- Main CSS -->
		<link rel="stylesheet" href="assets\css\style.css">

		<!-- BASE CSS -->
		<link href="css\style.css" rel="stylesheet">
		<link href="css\menu.css" rel="stylesheet">
		<link href="css\vendors.css" rel="stylesheet">
		<link href="css\icon_fonts\css\all_icons_min.css" rel="stylesheet">

		<script 
		src="https://ajax.googleapis.com/ajax/libs/jquery/3.4.1/jquery.min.js"></script>
		
		<!-- HTML5 shim and Respond.js IE8 support of HTML5 elements and media queries -->
		<!--[if lt IE 9]>
			<script src="assets/js/html5shiv.min.js"></script>
			<script src="assets/js/respond.min.js"></script>
		<![endif]-->
	
	</head>
	<body>
		<!-- Appointment Details Modal -->
		<div class="modal fade custom-modal" id="appt_details">
			<div class="modal-dialog modal-dialog-centered">
				<div class="modal-content">
					<div class="modal-header">
						<h5 class="modal-title">Appointment Details</h5>
						<button type="button" class="close" data-dismiss="modal" aria-label="Close">
							<span aria-hidden="true">&times;</span>
						</button>
					</div>
					<div class="modal-body">
						<ul class="info-details">
							<li>
								<div class="details-header">
									<div class="row">
										<div class="col-md-6"> 
											<strong>#APPT</strong>
											<strong><span class="appt_number"></span></strong><br>
											
											
										</div>
										<div class="col-md-6">
											<div class="text-right">
												<!-- <button type="button" class="btn bg-success-light btn-sm" id="topup_status">Completed</button> -->
											</div>
										</div>
									</div>
								</div>
							</li>
							<li>
								<span class="title">Status:</span>
								<span class="appt_status"></span>
							</li>
							<li>
								<span class="title">Date:</span>
								<span class="appt_date"></span>
							</li>
							<li>
								<span class="title">Paid Amount</span>
								$<span class="appt_paid"></span>
							</li>
						</ul>
					</div>
				</div>
			</div>
		</div>
		<!-- /Appointment Details Modal -->

		<!-- Main Wrapper -->
		<div class="main-wrapper">
		
			<!-- Header -->
			<header class="navbar navbar-expand-lg header-nav header_sticky">
				<div class="navbar-header">
					<a id="mobile_btn" href="javascript:void(0);">
						<span class="bar-icon">
							<span></span>
							<span></span>
							<span></span>
						</span>
					</a>
					<a href="doctor-dashboard.html" class="navbar-brand logo">
						<img src="img/logo2.PNG" class="img-fluid" alt="Logo">
					</a>
				</div>
				<div class="main-menu-wrapper">
					<div class="menu-header">
						<a href="doctor-dashboard.html" class="menu-logo">
							<img src="img/logo2.PNG" class="img-fluid" alt="Logo">
						</a>
						<a id="menu_close" class="menu-close" href="javascript:void(0);">
							<i class="fas fa-times"></i>
						</a>
					</div>
					<h4 style="margin-top: 10px;">Doctor Dashboard</h4>
				</div>		 
				<ul class="nav header-navbar-rht">
					<!-- User Menu -->
					<li class="nav-item dropdown has-arrow logged-item">
						<a href="#" class="dropdown-toggle nav-link" data-toggle="dropdown">
							<span class="user-img">
								<img class="rounded-circle" width="31" alt="Darren Elder" id="userimage1">
							</span>
						</a>
						<div class="dropdown-menu dropdown-menu-right">
							<div class="user-header">
								<div class="avatar avatar-sm">
									<img alt="User Image" class="avatar-img rounded-circle" id="userimage2">
								</div>
								<div class="user-text">
									<h6 class="username">name</h6>
									<p class="text-muted mb-0">Doctor</p>
								</div>
							</div>
                            <a class="dropdown-item" href="doctor-dashboard.html">Dashboard</a>
                            <a class="dropdown-item" href="notifications.html">Notifications</a>
							<a class="dropdown-item" href="doctor-profile-settings.html">Profile Settings</a>
							<a class="dropdown-item" href="doctor-login.html">Logout</a>
						</div>
					</li>
					<!-- /User Menu -->
					</ul>
				</nav>
			</header>
			<!-- /Header -->
			
			<!-- Page Content -->
			<div class="content">
				<div class="container-fluid">

					<div class="row">
						<div class="col-md-5 col-lg-4 col-xl-3 theiaStickySidebar">
						
							<!-- Profile Sidebar -->
							<div class="profile-sidebar">
								<div class="widget-profile pro-widget-content">
									<div class="profile-info-widget">
										<a href="#" class="booking-doc-img">
											<img alt="User Image" id="userimage3">
										</a>
										<div class="profile-det-info">
											<h3 class="username">name</h3>
											
											<div class="patient-details">
												<h5 class="mb-0" id="services">BDS, MDS - Geriatric Medicine</h5>
											</div>
										</div>
									</div>
								</div>
								<div class="dashboard-widget">
									<nav class="dashboard-menu">
										<ul>
											<li>
												<a href="doctor-dashboard.html">
													<i class="fas fa-columns"></i>
													<span>Dashboard</span>
												</a>
											</li>
											<li class="active">
												<a href="appointments.html">
													<i class="fas fa-book-medical"></i>
													<span>Appointments</span>
												</a>
											</li>
											<li>
												<a href="my-patients.html">
													<i class="fas fa-user-injured"></i>
													<span>My Patients</span>
												</a>
											</li>
											<li>
												<a href="schedule-timings.html">
													<i class="fas fa-hourglass-start"></i>
													<span>Schedule Timings</span>
												</a>
											</li>
											<li>
												<a href="notifications.html">
													<i class="fas fa-bell"></i>
													<span>Notifications</span>
												</a>
											</li>
											<li>
												<a href="doctor-profile-settings.html">
													<i class="fas fa-user-cog"></i>
													<span>Profile Settings</span>
												</a>
											</li>
											<li>
												<a href="doctor-change-password.html">
													<i class="fas fa-lock"></i>
													<span>Change Password</span>
												</a>
											</li>
											<li>
												<a href="doctor-login.html">
													<i class="fas fa-sign-out-alt"></i>
													<span>Logout</span>
												</a>
											</li>
										</ul>
									</nav>
								</div>
							</div>
							<!-- /Profile Sidebar -->
							
						</div>
						<!-- appointment list -->
						<div class="col-md-7 col-lg-8 col-xl-9">
							<div class="appointments">
								<script>
									var appt_dict = {};
									function showError(message) {
										$('#appointments').hide();
										$('#appointments')
											.append("<label>"+message+"</label>");
									}
									$(async() => {          
										var did = sessionStorage.getItem('sessionid');
										var serviceURL = "http://127.0.0.1:8000/api/v1/booking";
										serviceURL += "/"+"did="+did;
										try {
											const response =
											await fetch(
												serviceURL, { method: 'GET' }
											);
											const data = await response.json();
											var appointments = data.bookings; 
											
											if (!appointments || !appointments.length) {
												showError('No current booking');
											} else {
												var rows = "";
												for (const appointment of appointments) {
													var serviceURL = "http://127.0.0.1:8000/api/v1/customer/";
													var customerid = appointment.customerID;
													if (customerid && customerid.length) {
														serviceURL += customerid;
														
														try {
															const response =
															await fetch(
																serviceURL, { method: 'GET' }
															);
															const data = await response.json();
															var customer = data;
															var patientimg = "patient" + customerid[1];
															var image = "assets/img/patients/" + patientimg +".jpg";
															//check if started or not
															var apptStatus = appointment.status
															if (apptStatus.toLowerCase() == 'started'){
																var apptElement = "<a href='javascript:void(0);' class='btn btn-sm bg-success-light'>"+
																				"<i class='fas fa-check'></i> Appointment Ongoing"+
																			"</a>"
															} else{
																var apptElement = "<a href='javascript:void(0);' class='btn btn-sm bg-success-light'>"+
																				"<i class='fas fa-check'></i> Start Appointment"+
																			"</a>"
															}
															
															appointmentlist = "<div class='appointment-list'>" +
																					"<div class='profile-info-widget'>" +
																						"<a href='patient-profile.html' class='booking-doc-img'>" +
																							"<img src ="+ image +" alt='User Image'>" +
																						"</a>"+
																						"<div class='profile-det-info'>"+
																							"<h3><a href='patient-profile.html'>"+customer.name+"</a></h3>"+
																							"<div class='patient-details'>";
															profile =
																"<h5><i class='far fa-clock'></i>" + appointment.datestart + "</h5>" +
																"<h5><i class='fas fa-map-marker-alt'></i>" + customer.postalcode + "</h5>" +
																"<h5><i class='fas fa-envelope'></i>" + customer.email + "</h5>" +
																"<h5 class='b-0'><i class='fas fa-phone'></i>" + customer.phone + "</h5>" + 
																"<h5>" + "Booking ID: #" + "<span class='booking'>" + appointment.bookingID + "<span></h5>";

																
															appointmentaction = "</div>"+
																			"</div>"+
																		"</div>"+
																		"<div class='appointment-action'>"+
																			"<a href='#appt_details'' class='open-Dialog btn btn-sm bg-info-light' data-toggle='modal' data-id='"+ appointment.bookingID+"' >"+
																				"<i class='far fa-eye'></i> View"+
																			"</a>"+
																			apptElement +
																		"</div>"+
																	"</div>";
															
															rows = appointmentlist + profile + appointmentaction;
															

															$('.appointments').append(rows);
															
															appt_dict[appointment.bookingID] = appointment;

															
														
														} catch (error) {
															showError
															('There is a problem retrieving customer data, please try again later.<br />'+error);
														}
													
													}
												}
											} 
										}catch (error) {
											showError
											('There is a problem retrieving booking data, please try again later.<br />'+error);
										}
									});

				
								</script>
									<!-- when 'view' is clicked -->
								<script>
									$(document).on("click", ".open-Dialog", function () {
										var bookingid = $(this).data('id');
										$(".appt_number").html(bookingid);
										var appt_array= appt_dict[bookingid];
											
										var appointment_datestart= appt_array.datestart;
										var appointment_status = appt_array.status;
										var appointment_price = appt_array.price;
										$(".appt_date").html(appointment_datestart);
										$(".appt_status").html(appointment_status);
										$(".appt_paid").html(appointment_price);
		
									});
								</script>
								

							</div>
						</div>
					</div>

				</div>

			</div>		
			<!-- /Page Content -->
			<script>
				if(sessionStorage.getItem('sessionid') != null){
					$(document).ready(pageReady());
					function pageReady(){
						var serviceURL = "http://127.0.0.1:8000/api/v1/doctor";
						$(async() => {
							try {
								const response =
								await fetch(
									serviceURL, { method: 'GET' }
								);
								const data = await response.json();
								var doctors = data.doctors; 
								if (!doctors || !doctors.length) {
									showError('No doctor!')
								} else {
									for (const doctor of doctors) {
										var doctorid = doctor.doctorID;
										if(sessionStorage.getItem('sessionid') == doctorid){
											console.log(sessionStorage.getItem('sessionid'));
											$(".username").text(doctor.name);
											var imgname = "doctor" + doctorid[1];
											$("#userimage1").attr("src","assets/img/doctors/"+ imgname + ".jpg");
											$("#userimage2").attr("src","assets/img/doctors/"+ imgname + ".jpg");
											$("#userimage3").attr("src","assets/img/doctors/"+ imgname + ".jpg");
											$("#services").text(doctor.services);
										}
									}
								}
						} catch (error) {
							('There is a problem retrieving customer data, please try again later.<br />'+error);
						} 
							});
						}
				} else{
					window.location.replace("doctor-login.html");
				}
			</script>
			<!-- /white_bg -->
			<div class="container">
				<footer>
					<div class="container margin_60_35">
						<div class="row">
							<div class="col-lg-3 col-md-12">
								<p>
									<a href="index.html" title="FastDoc">
										<img src="img\logo2.png" data-retina="true" alt="" width="163" height="36" class="img-fluid">
									</a>
								</p>
							</div>
							<div class="col-lg-3 col-md-4">
								<h5>About</h5>
								<ul class="links">
									<li><a href="about.html">About us</a></li>
									<li><a href="contacts.html">Contact Us</a></li>
									<li><a href="login.html">Login</a></li>
									<li><a href="register.html">Register</a></li>
								</ul>
							</div>
							<div class="col-lg-3 col-md-4">
								<h5>Useful links</h5>
								<ul class="links">
									<li><a href="map-list.html">Our Doctors</a></li>
									<li><a href="register.html">Join as a Patient</a></li>
									<li><a href="doctor-register.html">Join as a Doctor</a></li>
								</ul>
							</div>
							<div class="col-lg-3 col-md-4">
								<h5>Contact with Us</h5>
								<ul class="contacts">
									<li><a href="tel://61280932400"><i class="icon_mobile"></i> + 65 1234 5678</a></li>
									<li><a href="mailto:info@fastdoc.com"><i class="icon_mail_alt"></i> help@fastdoc.com</a></li>
								</ul>
								<div class="follow_us">
									<h5>Follow us</h5>
									<ul>
										<li><a href="#0"><i class="social_facebook"></i></a></li>
										<li><a href="#0"><i class="social_twitter"></i></a></li>
										<li><a href="#0"><i class="social_linkedin"></i></a></li>
										<li><a href="#0"><i class="social_instagram"></i></a></li>
									</ul>
								</div>
							</div>
						</div>
						<!--/row-->
						<hr>
						<div class="row">
							<div class="col-md-8">
								<ul id="additional_links">
									<li><a href="#0">Terms and conditions</a></li>
									<li><a href="#0">Privacy</a></li>
								</ul>
							</div>
							<div class="col-md-4">
								<div id="copy">© 2020 FastDoc</div>
							</div>
						</div>
					</div>
				</footer>
				<!--/footer-->
			</div>
		</div>
		<!-- /Main Wrapper -->
		
		
	  
		<!-- jQuery -->
		<script src="assets\js\jquery.min.js"></script>
		
		<!-- Bootstrap Core JS -->
		<script src="assets\js\popper.min.js"></script>
		<script src="assets\js\bootstrap.min.js"></script>
		
		<!-- Sticky Sidebar JS -->
        <script src="assets\plugins\theia-sticky-sidebar\ResizeSensor.js"></script>
        <script src="assets\plugins\theia-sticky-sidebar\theia-sticky-sidebar.js"></script>
		
		<!-- Custom JS -->
		<script src="assets\js\script.js"></script>
		
		<!-- <script src="assets\js\appointment.js"></script> -->
		<script>
			var x = document.getElementsByClassName('bg-info-light').length
if (x==0){
    setTimeout(onReady,1000)
}

function onReady(){
    $('.bg-success-light').click(function(){
        console.log('clicked');
        var element = this;
        var bid = this.parentNode.parentNode.querySelector('h5 span.booking').textContent
        getLocation();
        function getLocation() {
            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(showPosition);
            } else {
                alert("Geolocation is not supported by this browser.");
            }
        }
        
        function showPosition(position) {
            var pos = {lat:position.coords.latitude, long:position.coords.longitude}
            function showError(message) {
                alert(message)
            }
            
            $(async() => {
                serviceURL = 'http://localhost:8000/api/v1/start_booking';
                try{
                    const response =
                    await fetch(
                        serviceURL,
                        {
                            method: "POST",
							headers: {"Content-Type" : "application/json"},
							mode: 'no-cors',
                            body: JSON.stringify({
								doctorID: sessionStorage.getItem('sessionid'),
                                bookingID: bid,
                                status: "started",
                                location: pos
                            })
                        })
                }catch (error){
                    showError('h');
                }finally{
                    window.location.reload();
                }
			});
        }
    })
}

		</script>
		
	</body>
</html>